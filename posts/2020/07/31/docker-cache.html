<!DOCTYPE html>
<html lang="ko-KR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SPA 배포를 위한 도커 - 의존성 cache를 위한 Dockerfile 만들기 | 생계형 🐾者</title>
    <meta name="generator" content="VuePress 1.5.3">
    <meta name="description" content="빠른 배포를 위한 cache용 Dockerfile을 만들어보자">
    <link rel="preload" href="/assets/css/0.styles.a760f68a.css" as="style"><link rel="preload" href="/assets/js/app.4cbb8bd7.js" as="script"><link rel="preload" href="/assets/js/11.8a2af103.js" as="script"><link rel="preload" href="/assets/js/18.b6542bdb.js" as="script"><link rel="prefetch" href="/assets/js/1.71150f46.js"><link rel="prefetch" href="/assets/js/10.092ad01e.js"><link rel="prefetch" href="/assets/js/12.6e69d991.js"><link rel="prefetch" href="/assets/js/13.d474a548.js"><link rel="prefetch" href="/assets/js/14.08da88c9.js"><link rel="prefetch" href="/assets/js/15.91027415.js"><link rel="prefetch" href="/assets/js/16.c40e445a.js"><link rel="prefetch" href="/assets/js/17.09862d2e.js"><link rel="prefetch" href="/assets/js/19.77e0ba09.js"><link rel="prefetch" href="/assets/js/20.bcca7d0d.js"><link rel="prefetch" href="/assets/js/21.22802ba4.js"><link rel="prefetch" href="/assets/js/22.e91c711d.js"><link rel="prefetch" href="/assets/js/23.709ee5af.js"><link rel="prefetch" href="/assets/js/3.8257086b.js"><link rel="prefetch" href="/assets/js/4.e398776e.js"><link rel="prefetch" href="/assets/js/5.6220f8dd.js"><link rel="prefetch" href="/assets/js/6.ece0e64d.js"><link rel="prefetch" href="/assets/js/7.3cce7458.js"><link rel="prefetch" href="/assets/js/8.6da1e87b.js"><link rel="prefetch" href="/assets/js/9.6bc8fee4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a760f68a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          생계형 🐾者
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Post
          </a><a href="https://github.com/yoonhona" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>Github</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          SPA 배포를 위한 도커 - 의존성 cache를 위한 Dockerfile 만들기
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-07-31
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-08-13
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/07/17/docker-start.html" class="post-link" data-v-4e23451f>
      Previous Post : SPA 배포를 위한 도커 - 들어가기
    </a> <a href="/posts/2020/08/14/dotfiles.html" class="post-link" data-v-4e23451f>
      Next Post : 어떤 프론트엔드 개발자의 개발환경 - Dotfiles
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><div class="custom-block tip"><p class="custom-block-title">작성 환경</p> <p>osx catalina<br>
docker desktop community 2.3.0.4<br>
도커 데몬 CPU 8, memory 2GB<br> <a href="https://github.com/yoonhona/study/tree/master/example/docker/cache" target="_blank" rel="noopener noreferrer">사용된 소스 코드<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <p><img src="https://www.docker.com/sites/default/files/d8/2019-07/horizontal-logo-monochromatic-white.png" alt=""></p> <p>일단
<a href="https://create-react-app.dev/" target="_blank" rel="noopener noreferrer">Create React App<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><sup>이하⎺CRA</sup> 을 사용하여
간단히 React 프로젝트 세팅을 해보자.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>npx create-react-app my-app
<span class="token builtin class-name">cd</span> my-app
<span class="token comment"># node_modules 크기 확인</span>
<span class="token function">du</span> -hcs node_modules
247M    node_modules
247M    total
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>CRA 문서에 따라 my-app이라는 폴더에 설치 후 만들어진 프로젝트 내 설치된 의존성(node_modules) 크기를 확인해보자.<br>
247M가 나온다.<br> <code>머 이정도야</code> 일단 한번 도커를 사용하여 빌드하여 이미지를 만들어보자.</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># nginx.conf</span>
<span class="token keyword">server</span> <span class="token punctuation">{</span>
	<span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
	<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
		<span class="token keyword">root</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
		<span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
		<span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token comment"># node alpine 이미지를 base로 하고</span>
<span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as build
<span class="token comment"># /app 디렉토리 생성 후 프로젝트 폴더를 /app 복사한다.</span>
<span class="token keyword">WORKDIR</span> /app
<span class="token keyword">COPY</span> . /app
<span class="token comment"># 의존성 설치 후 빌드를 실행</span>
<span class="token keyword">RUN</span> yarn
<span class="token keyword">RUN</span> yarn build
<span class="token comment"># 서비스를 실행할 nginx를 alpine 이미지를 base로 하여  </span>
<span class="token keyword">FROM</span> nginx<span class="token punctuation">:</span>alpine
<span class="token comment"># 만들어 놓은 nginx 설정 파일과 위에서 빌드한 결과물을 복사한다. </span>
<span class="token keyword">COPY</span> ./nginx.conf /etc/nginx/conf.d
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=build /app/build /usr/share/nginx/html
<span class="token keyword">EXPOSE</span> 80
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;nginx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;daemon off;&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>일단 nginx 환경 설정 파일을 간단하게 만들고,<br>
Dockerfile도 간단하게 만들어보자.<br>
그리고 <code>docker build</code>하여 시간이 얼마나 걸리는지 살펴보자.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 시간을 확인하기 위해서 BUILDKIT 활용 </span>
<span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> docker build <span class="token builtin class-name">.</span>
<span class="token comment"># 실행 결과</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">113</span>.4s <span class="token punctuation">(</span><span class="token number">14</span>/14<span class="token punctuation">)</span> FINISHED
 <span class="token punctuation">..</span>.
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context               <span class="token number">8</span>.8s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: <span class="token number">152</span>.55MB           <span class="token number">8</span>.6s
 <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p><a href="https://docs.docker.com/develop/develop-images/build_enhancements/" target="_blank" rel="noopener noreferrer">BuildKit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>총 113.4초가 걸린것을 확인할 수 있는데 시간을 살펴보기 전에 context라는 것을
살펴보자.<br>
context는 도커 빌드 시 대상이 되는 디렉토리로 도커 빌드가 일어나면 도커 데몬에
복사되게되는데<br>
context가 되는 프로젝트 폴더에는 node_modules가 존재하기 때문에 이미 용량이
많이 커져 있게 된다.<br>
이런 파일들을 context에서 제외 시킬 수 있는 <code>.dockerignore</code> 파일을 설정할
필요가 있다.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># .dockerignore</span>
node_modules
build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> docker build <span class="token builtin class-name">.</span>
<span class="token comment"># 실행 결과</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">99</span>.1s <span class="token punctuation">(</span><span class="token number">14</span>/14<span class="token punctuation">)</span> FINISHED
 <span class="token punctuation">..</span>.
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context      <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: <span class="token number">509</span>.52kB  <span class="token number">0</span>.0s
 <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>.dockerignore</code>에 node_modules와 build 디렉토리를 제외하도록 설정 후 빌드를
실행하면 불 필요한 파일이 복사되지 않아 context의 크기가 줄어듬을 확인할 수
있다.</p> <p>이제 빌드 과정을 살펴보자.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">99</span>.1s <span class="token punctuation">(</span><span class="token number">14</span>/14<span class="token punctuation">)</span> FINISHED
<span class="token punctuation">..</span>.
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">2</span>/5<span class="token punctuation">]</span> WORKDIR /app                             <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>stage-1 <span class="token number">2</span>/3<span class="token punctuation">]</span> COPY ./nginx.conf /etc/nginx/conf.d    <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">3</span>/5<span class="token punctuation">]</span> COPY <span class="token builtin class-name">.</span> /app                              <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">4</span>/5<span class="token punctuation">]</span> RUN <span class="token function">yarn</span>                                <span class="token number">90</span>.8s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">5</span>/5<span class="token punctuation">]</span> RUN <span class="token function">yarn</span> build                           <span class="token number">7</span>.6s
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>한눈에도 알 수 있듯이 의존성 설치 명령이 <code>yarn</code>에서 90초가 넘게 걸렸다.<br>
지금 프로젝트에는 가장 기본적인 설정만 되어 있다는 것을 명심하자.<br>
앞으로 의존성은 더 늘어나면 늘어나지 줄지는 않을 것이다.<br>
그리고 npm 생태계 특성상 프로젝트에서 1개의 의존성을 추가하였다고 해도 1개가 아닐
가능성이 더 높다.</p> <p>이제 맨 위에서 <code>머 이정도야</code> 했던 것이 이정도가 아니게 되어버렸다.</p> <p>이제 이 부분을 최적화해야 할 것 같은데 이미 여러 최적화 방법이 있고 여기서는
<a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener noreferrer"><code>multi-stage builds</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>를
사용하려 한다.</p> <p>일단 의존성 cache를 위한 부분을 수정해보자.</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>alpine as dependences
<span class="token comment"># /app 디렉토리 생성 후 프로젝트 폴더를 /app 복사한다.</span>
<span class="token keyword">WORKDIR</span> /app
<span class="token keyword">COPY</span> package.json /app/
<span class="token comment"># 의존성 설치</span>
<span class="token keyword">RUN</span> yarn
<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>변경된 부분을 살펴보면</p> <ol><li><code>FROM node:alpine as dependences</code><br>
처음 FROM 절에 name이 추가되었다. 의존성 cache 후에 프로젝트를 빌드하는
단계에서 cache를 베이스로 하기 위함이다.</li> <li><code>COPY package.json /app/</code><br>
전체를 복사하지 않고 프로젝트의 의존성을 관리하는 <code>package.json</code>만 복사하도록
변경되었다.<br>
COPY 명령어로 레이어가 생성될 때는 COPY되는 파일의 변경에 따라 생성이 되는데
프로젝트 전체 파일을 대상으로 하게되면 프로젝트의 의존성 변경과 관계없이
레이어가 변경이 되기 때문에 <code>package.json</code>만 복사하게되면 프로젝트 의존성
변경이 없으면 기존에 빌드된 이미지를 도커가 cache 할 것이다.</li></ol> <p>의존성 cache 부분을 변경하면서 빌드를 제외하였기 때문에 빌드 부분을 추가해보면</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token punctuation">...</span>
<span class="token keyword">FROM</span> dependences as build
<span class="token keyword">COPY</span> . /app
<span class="token keyword">RUN</span> yarn build
<span class="token punctuation">...</span> 
<span class="token comment"># Nginx 부분 동일</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>라인 별로 살펴보면</p> <ol><li><code>FROM dependences</code>는 위의 의존성 cache한 부분을 base로 하고 있다.<br>
이게 어떻게 동작하는지는 나중에 살펴보자.</li> <li>나머지 프로젝트내 파일을 복사한다.</li> <li>빌드를 실행한다.</li></ol> <p>크게 바뀐 부분은 의존성 설치와 빌드단계를 나눴다는 것이다.<br>
하지만 다들 알다시피 도커 빌드는 위에서 아래로 흐른다.<br>
그러면 빌드 단계 앞에 의존성 설치 부분이 존재하기 때문에 빌드 단계에서 의존성
설치가 진행되지 않을까?<br>
이 부분 도커 빌드를 하면서 살펴보자</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> docker build <span class="token builtin class-name">.</span> --target<span class="token operator">=</span>dependences -t dependences
<span class="token comment"># 실행 결과</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">2</span>.4s <span class="token punctuation">(</span><span class="token number">9</span>/9<span class="token punctuation">)</span> FINISHED
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring dockerfile: 37B
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: 34B
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/node:alpine
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>dependences <span class="token number">1</span>/4<span class="token punctuation">]</span> FROM docker.io/library/node:alpine@sha256:<span class="token punctuation">..</span>.
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: 34B
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">2</span>/4<span class="token punctuation">]</span> WORKDIR /app
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">3</span>/4<span class="token punctuation">]</span> COPY package.json /app/
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">4</span>/4<span class="token punctuation">]</span> RUN <span class="token function">yarn</span>
 <span class="token operator">=</span><span class="token operator">&gt;</span> exporting to image
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> exporting layers
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> writing image sha256:<span class="token punctuation">..</span><span class="token punctuation">..</span>
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> naming to docker.io/library/dependences
<span class="token comment"># 이미지 검색</span>
docker images <span class="token operator">|</span> <span class="token function">grep</span> dependences
<span class="token comment"># 이미지 검색 결과</span>
REPOSITORY    TAG   IMAGE ID            CREATED             SIZE
dependences latest  67b2b7604004        About an hour ago   441MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>먼저 의존성 cache를 위해서 빌드를 하였다.<br>
빌드 명령어에 두가지가 추가되었는데<br> <code>--target=dependences</code>은 첫 번째 stage인 <code>FROM node:alpine as dependences</code>만 실행하라는 것이고 그렇게 의존성이 설치된 이미지의 tag를 지정하기
위해 <code>-t dependences</code> 추가하여 dependences라고 tag를 달아 주었다.</p> <p>이어서 프로젝트 빌드 단계를 진행하면</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> docker build <span class="token builtin class-name">.</span> --target<span class="token operator">=</span>build --cache-from<span class="token operator">=</span>dependences -t build
<span class="token comment"># 결과</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">12</span>.0s <span class="token punctuation">(</span><span class="token number">12</span>/12<span class="token punctuation">)</span> FINISHED                                               
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: 34B                                             <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile                         <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring dockerfile: 37B                                          <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/node:alpine               <span class="token number">2</span>.1s
 <span class="token operator">=</span><span class="token operator">&gt;</span> importing cache manifest from dependences                                <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>dependences <span class="token number">1</span>/4<span class="token punctuation">]</span> FROM docker.io/library/node:alpine@sha256:<span class="token punctuation">..</span>.          <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> transferring context: <span class="token number">509</span>.11kB                                        <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">2</span>/4<span class="token punctuation">]</span> WORKDIR /app                                    <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">3</span>/4<span class="token punctuation">]</span> COPY package.json /app/                         <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> CACHED <span class="token punctuation">[</span>dependences <span class="token number">4</span>/4<span class="token punctuation">]</span> RUN <span class="token function">yarn</span>                                        <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">1</span>/2<span class="token punctuation">]</span> COPY <span class="token builtin class-name">.</span> /app                                                  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>build <span class="token number">2</span>/2<span class="token punctuation">]</span> RUN <span class="token function">yarn</span> build                                               <span class="token number">9</span>.7s
 <span class="token operator">=</span><span class="token operator">&gt;</span> exporting to image                                                       <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> exporting layers                                                      <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> writing image sha256:<span class="token punctuation">..</span>.                                              <span class="token number">0</span>.0s 
 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> naming to docker.io/library/build                                     <span class="token number">0</span>.0s 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>여기서는 <code>--cache-from=dependences</code> 추가되었다.</p> <p>중간에 이야기 했듯이 도커 빌드는 Dockerfile의 위에서 아래로 흐르기 때문에 의존성
설치 부분이 이미 빌드가 된 이미지를 참조하기 때문에 13~15라인은 도커에서 cache
처리된것을 확인 할 수 있다.</p> <p>그렇기 때문에 90초 이상이 걸리던 의존성 설치부분이 cache되어 0초가 되었다.<br>
배포를 위한 빌드 단계의 시간을 절약할 수 있게 되었다.<br>
이제 의존성 부분을 이미지화 하는 부분을 CI단계에서 자동화 처리한다면 배포를 위해서
시간은 더 단축될것이다.</p> <hr> <p>참고</p> <ol><li>도커 <a href="https://docs.docker.com/storage/storagedriver/" target="_blank" rel="noopener noreferrer">레이어<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener noreferrer">multi-stage builds<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-07-31
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-08-13
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/07/17/docker-start.html" class="post-link" data-v-4e23451f>
      Previous Post : SPA 배포를 위한 도커 - 들어가기
    </a> <a href="/posts/2020/08/14/dotfiles.html" class="post-link" data-v-4e23451f>
      Next Post : 어떤 프론트엔드 개발자의 개발환경 - Dotfiles
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="https://avatars1.githubusercontent.com/u/10597948?s=460&amp;v=4" alt="생계형 🐾者" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      생계형 🐾者
    </section> <section class="info-desc" data-v-9d847660>생계형 개발자의 블로그입니다.<br />프론트 엔드 개발을 하며<br /> React.js를 다룹니다.</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Seoul, Korea" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Seoul, Korea</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Seoul, Korea
        </span></span></section> <!----> <section data-v-9d847660><a href="mailto:lucky7_nyh@naver.com" title="lucky7_nyh@naver.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>lucky7_nyh@naver.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          lucky7_nyh@naver.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://github.com/yoonhona" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: yoonhona" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: yoonhona</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://www.facebook.com/profile.php?id=100001763897524" target="_blank" class="sns-link" data-v-9d847660><span title="Facebook: Na Yoonho" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Facebook: Na Yoonho</title><use xlink:href="#icon-facebook" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://yoonhona.github.io/rss" target="_blank" class="sns-link" data-v-9d847660><span title="RSS: " class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>RSS: </title><use xlink:href="#icon-rss" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><!----> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2020/07/31/docker-cache.html#post-comments">
      Comments
    </a></div></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://github.com/yoonhona" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: yoonhona" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: yoonhona</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://www.facebook.com/profile.php?id=100001763897524" target="_blank" class="sns-link" data-v-1375e54c><span title="Facebook: Na Yoonho" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Facebook: Na Yoonho</title><use xlink:href="#icon-facebook" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://yoonhona.github.io/rss" target="_blank" class="sns-link" data-v-1375e54c><span title="RSS: " class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>RSS: </title><use xlink:href="#icon-rss" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <!----></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.4cbb8bd7.js" defer></script><script src="/assets/js/11.8a2af103.js" defer></script><script src="/assets/js/18.b6542bdb.js" defer></script>
  </body>
</html>
